---
title: "app.rmd"
author: "Sara Diamond"
date: "4/3/2022"
output: pdf_document
---

```{r setup, include=FALSE}
getwd()
setwd("/Users/saradiamond/Documents/Environmental_Data_Analytics_2022")

#### Load packages ----
library(shiny)
library(shinythemes)
library(tidyverse)

#### Load data ----
# Read in PeterPaul processed dataset for nutrients. 
# Specify the date column as a date
# Remove negative values for depth_id 
# Include only lakename and sampledate through po4 columns
nutrient_data <- read_csv("Data/NTL-LTER_Lake_Nutrients_PeterPaul_Processed.csv")
nutrient_data$sampledate <- as.Date(nutrient_data$sampledate, format = "%Y-%m-%d")
nutrient_data <- nutrient_data %>%
  filter(depth_id > 0) %>%
  select(lakename, sampledate:po4)
  

#### Define UI ----
ui <- fluidPage(theme = shinytheme("cyborg"),
  # Choose a title
  titlePanel("Different Nutrients Found in Peter Lake and Paul Lake Over Time"),
  sidebarLayout(
    sidebarPanel(
      
      # Select nutrient to plot
      selectInput(inputId = "nutrientid",
                  label = "Nutrient Type",
                  choices = c("tn_ug", "tp_ug", "nh34", "no23", "po4"), 
                  selected = "tn_ug"),
      
    
      
      # Select depth
      checkboxGroupInput(inputId = "depths",
                         label = "Depth",
                         choices = unique(nutrient_data$depth_id),
                         selected = c(1, 7)),
      
      # Select lake
      checkboxGroupInput(inputId = "lakes",
                         label = "Lake Options",
                         choices = c("Peter Lake", "Paul Lake"),
                         selected = "Peter Lake"),

      # Select date range to be plotted
      sliderInput(inputId = "dates",
                  label = "Date Options",
                  min = as.Date("1991-05-01"),
                  max = as.Date("2016-12-31"),
                  value = c(as.Date("1995-01-01"), as.Date("1999-12-31")))),

    # Output: Description, lineplot, and reference
    mainPanel(
      # Specify a plot output
      plotOutput("nutrientplot", brush = brushOpts(id = "nutrientplot_brush")), 
      # Specify a table output
      tableOutput("saratable")
    )))

#### Define server  ----
server <- function(input, output) {
  
    # Define reactive formatting for filtering within columns
     filtered_nutrient_data <- reactive({
        nutrient_data %>%
         # Filter for dates in slider range
         filter(sampledate >= input$dates[1] & sampledate <= input$dates[2]) %>%
         # Filter for depth_id selected by user
         filter(depth_id %in% input$depths) %>%
         # Filter for lakename selected by user
         filter(lakename %in% input$lakes) 
     })
    
    # Create a ggplot object for the type of plot you have defined in the UI  
       output$nutrientplot <- renderPlot({
         ggplot(filtered_nutrient_data(), 
                aes_string(x = "sampledate", y = input$nutrientid, 
                           fill = "depth_id", shape = "lakename")) +
           geom_point(alpha = 0.8, size = 3) +
           theme_light(base_size = 14) +
           scale_shape_manual(values = c(21, 24)) +
           labs(x = "Date", y = expression(Concentration ~ (mu*g / L)), shape = "Lake Name", fill = "Depth") +
           scale_fill_distiller(palette = "YlOrRd", guide = "colorbar", direction = 1)
          
      })
       
    # Create a table that generates data for each point selected on the graph  
       output$saratable <- renderTable({
         brush_out <- brushedPoints(filtered_nutrient_data(), input$nutrientplot_brush)
       })
       
  }


#### Create the Shiny app object ----
shinyApp(ui = ui, server = server)

#### Questions for coding challenge ----
#1. Play with changing the options on the sidebar. 
    # Choose a shinytheme that you like. The default here is "yeti"
    # How do you change the default settings? 
    # How does each type of widget differ in its code and how it references the dataframe?
#2. How is the mainPanel component of the UI structured? 
    # How does the output appear based on this code?
#3. Explore the reactive formatting within the server.
    # Which variables need to have reactive formatting? 
    # How does this relate to selecting rows vs. columns from the original data frame?
#4. Analyze the similarities and differences between ggplot code for a rendered vs. static plot.
    # Why are the aesthetics for x, y, fill, and shape formatted the way they are?
    # Note: the data frame has a "()" after it. This is necessary for reactive formatting.
    # Adjust the aesthetics, playing with different shapes, colors, fills, sizes, transparencies, etc.
#5. Analyze the code used for the renderTable function. 
    # Notice where each bit of code comes from in the UI and server. 
    # Note: renderTable doesn't work well with dates. "sampledate" appears as # of days since 1970.

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
